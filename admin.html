<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blocks Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            padding: 2rem;
        }
        .container-main {
            max-width: 1200px; /* Increased max width */
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .active-pulse {
            background-color: #10b981;
            animation: pulse-green 1.5s infinite;
        }
        .paused-dot {
            background-color: #f59e0b;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        /* Log Colors */
        .log-entry.blocked { color: #dc2626; font-weight: 600; } 
        .log-entry.heuristic { color: #a855f7; font-weight: 600; } 
        .log-entry.client_denied { color: #842340; font-weight: 700; background-color: #fee2e2; padding: 4px; border-radius: 4px;} /* New Denied Style */
        .log-entry.error { color: #f59e0b; }
        .log-entry.change { color: #0ea5e9; }
        
        #history-log-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container-main">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900">Blocks Admin</h1>
            <p class="text-gray-500 mt-2">Manage your network-wide ad, tracker, and malware blocker.</p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-6 mb-8">
            
            <!-- LEFT COLUMN: STATUS & GLOBAL CONTROLS (3/5 width) -->
            <div class="xl:col-span-3">
                <div class="card mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Service Control & Monitoring</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">DNS Service Status:</span>
                            <div class="flex items-center text-lg font-bold mt-1">
                                <span id="dns-status-dot" class="status-dot"></span>
                                <span id="dns-status-text">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Blocked Domains:</span>
                            <span id="blocklist-count" class="font-bold text-lg text-red-700 block mt-1">0</span>
                        </div>

                        <div class="p-3 bg-gray-50 rounded-lg col-span-2">
                            <span class="font-medium text-gray-700">Current Public IP:</span>
                            <span id="current-ip" class="font-bold text-lg text-green-700 block mt-1 break-words">Loading...</span>
                        </div>

                        <div class="p-3 bg-gray-100 rounded-lg col-span-2 text-sm">
                            <span class="font-medium text-gray-700">List Updated:</span>
                            <span id="list-update-time" class="font-bold text-gray-800">N/A</span>
                            <span id="list-update-source" class="block text-xs text-gray-500 truncate">Source: N/A</span>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="toggle-dns-btn" class="w-full py-3 text-white font-bold rounded-lg transition duration-200">
                            Toggle DNS Service
                        </button>
                    </div>
                </div>

                <!-- HISTORY LOG -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Recent Activity Log (Last 50 Events)</h2>
                    <div id="history-log-container" class="space-y-1 text-sm">
                        <p class="text-center text-gray-500 py-4">Waiting for server data...</p>
                    </div>
                </div>
            </div>


            <!-- RIGHT COLUMN: CLIENT & BLOCKLIST MANAGEMENT (2/5 width) -->
            <div class="xl:col-span-2 space-y-6">
                
                <!-- CLIENT MANAGEMENT CARD (NEW) -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Client Management</h2>
                    <div class="flex justify-between space-x-2 mb-4">
                        <button id="unblock-all-btn" class="w-1/2 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-200 text-sm">
                            Allow All Clients
                        </button>
                        <button id="block-all-btn" class="w-1/2 py-2 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-800 transition duration-200 text-sm">
                            Block All Clients
                        </button>
                    </div>

                    <div id="client-list-container" class="bg-gray-50 p-3 rounded-lg max-h-64 overflow-y-auto border">
                        <h3 class="font-semibold mb-2">Logged Client IPs (Last Seen)</h3>
                        <ul id="client-list" class="space-y-2 text-sm">
                            <li>No clients seen yet.</li>
                        </ul>
                    </div>
                    <p id="client-message" class="mt-3 text-sm text-center font-medium"></p>
                </div>
                
                <!-- BLOCKLIST MANAGEMENT CARD (From previous step) -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Blocklist Management</h2>
                    
                    <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-800">1. Load External List (URL)</h3>
                    <div class="mb-4">
                        <input type="url" id="url-input" placeholder="e.g., https://list.adguard.com/..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    </div>
                    <button id="load-url-btn" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                        <span id="load-url-text">Download & Apply List</span>
                        <span id="load-url-spinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    <p id="load-url-message" class="mt-3 text-sm text-center font-medium"></p>


                    <h3 class="text-lg font-semibold mt-6 mb-2 text-gray-800">2. Add/Remove Single Domain</h3>
                    <div class="mb-4">
                        <input type="text" id="domain-input" placeholder="domain.com" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex space-x-3">
                        <button id="add-btn" class="w-1/2 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200">
                            + Add Domain
                        </button>
                        <button id="remove-btn" class="w-1/2 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">
                            - Remove Domain
                        </button>
                    </div>
                    <p id="management-message" class="mt-3 text-sm text-center font-medium"></p>
                    
                    <h3 class="text-lg font-semibold mt-6 mb-2">Current Blocklist Domains</h3>
                    <div id="current-blocklist-container" class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto border">
                        <ul id="current-blocklist" class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            <li>Loading blocklist...</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
        <!-- End Main Grid -->

    </div>

    <script>
        const API_BASE = '/api';
        const DOMAIN_REGEX = /^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}$/;

        // UI elements
        const statusDot = document.getElementById('dns-status-dot');
        const statusText = document.getElementById('dns-status-text');
        const toggleBtn = document.getElementById('toggle-dns-btn');
        const currentIp = document.getElementById('current-ip');
        const blocklistCount = document.getElementById('blocklist-count');
        const historyLogContainer = document.getElementById('history-log-container');
        const listUpdateTime = document.getElementById('list-update-time');
        const listUpdateSource = document.getElementById('list-update-source');
        
        // Blocklist UI
        const domainInput = document.getElementById('domain-input');
        const addBtn = document.getElementById('add-btn');
        const removeBtn = document.getElementById('remove-btn');
        const mgmtMessage = document.getElementById('management-message');
        const currentBlocklist = document.getElementById('current-blocklist');
        const urlInput = document.getElementById('url-input');
        const loadUrlBtn = document.getElementById('load-url-btn');
        const loadUrlText = document.getElementById('load-url-text');
        const loadUrlSpinner = document.getElementById('load-url-spinner');
        const loadUrlMessage = document.getElementById('load-url-message');

        // Client Control UI (NEW)
        const clientList = document.getElementById('client-list');
        const blockAllBtn = document.getElementById('block-all-btn');
        const unblockAllBtn = document.getElementById('unblock-all-btn');
        const clientMessage = document.getElementById('client-message');


        // --- Core Functions ---

        async function fetchStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                if (!response.ok) throw new Error('Failed to fetch status.');
                const data = await response.json();
                updateStatusUI(data);
                updateHistoryLog(data.history);
                updateClientList(data.clients); // NEW
            } catch (error) {
                console.error("Server connection failed:", error);
                handleServerDown();
            }
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            if (seconds < 60) return seconds <= 5 ? 'Just now' : `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        async function controlClient(ip, action) {
            clientMessage.textContent = 'Processing...';
            clientMessage.className = 'mt-3 text-sm text-center font-medium text-gray-500';

            try {
                const response = await fetch(`${API_BASE}/client/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, action })
                });

                const data = await response.json();
                if (data.success) {
                    fetchStatus(); // Refresh client list and status
                    displayClientMessage(data.message, 'text-green-600');
                } else {
                    displayClientMessage(data.message, 'text-yellow-600');
                }
            } catch (error) {
                displayClientMessage('Error communicating with server.', 'text-red-600');
            }
        }


        // --- UI Updates ---

        function updateStatusUI(data) {
            const isActive = data.dnsActive;
            
            // ... (DNS Status, Toggle Button, IP, Blocklist Count logic - mostly unchanged)
            statusText.textContent = isActive ? 'ACTIVE' : 'PAUSED';
            statusText.className = isActive ? 'text-green-600' : 'text-yellow-600';
            statusDot.className = `status-dot ${isActive ? 'active-pulse' : 'paused-dot'}`;
            
            toggleBtn.textContent = isActive ? 'STOP DNS SERVICE' : 'START DNS SERVICE';
            toggleBtn.classList.remove('bg-red-600', 'bg-green-600');
            toggleBtn.classList.add(isActive ? 'bg-red-600' : 'bg-green-600');
            toggleBtn.dataset.status = isActive ? 'active' : 'paused';
            toggleBtn.disabled = false;

            currentIp.textContent = data.ip;
            currentIp.className = `font-bold text-lg ${data.ip.startsWith('Error') ? 'text-red-500' : 'text-green-700'} break-words`;
            blocklistCount.textContent = data.blocklistSize.toLocaleString();

            listUpdateTime.textContent = data.lastListUpdateTime;
            listUpdateSource.textContent = `Source: ${data.lastListUpdateSource}`;

            fetchBlocklistDetails();
        }

        function updateClientList(clients) {
            if (clients.length === 0) {
                clientList.innerHTML = '<li>No clients seen yet.</li>';
                return;
            }

            // Sort clients: Denied first, then by last seen (most recent first)
            clients.sort((a, b) => {
                if (a.isDenied !== b.isDenied) {
                    return a.isDenied ? -1 : 1;
                }
                return b.lastSeen - a.lastSeen;
            });

            clientList.innerHTML = clients.map(client => {
                const statusColor = client.isDenied ? 'bg-red-500' : 'bg-green-500';
                const statusText = client.isDenied ? 'Blocked' : 'Allowed';
                const buttonAction = client.isDenied ? 'unblock' : 'block';
                const buttonColor = client.isDenied ? 'bg-green-600' : 'bg-red-600';
                const buttonText = client.isDenied ? 'Allow' : 'Block';

                return `
                    <li class="flex justify-between items-center p-2 rounded-lg ${client.isDenied ? 'bg-red-50' : 'bg-white'} border border-gray-200">
                        <div class="flex-shrink-0 mr-3">
                            <span class="font-mono text-gray-800 text-sm">${client.ip}</span>
                            <div class="text-xs text-gray-500 mt-0.5">Last Seen: ${formatTimeAgo(client.lastSeen)}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-0.5 text-xs font-semibold rounded-full text-white ${statusColor}">${statusText}</span>
                            <button onclick="controlClient('${client.ip}', '${buttonAction}')" 
                                class="py-1 px-3 text-xs font-semibold rounded-lg text-white ${buttonColor} hover:opacity-80 transition duration-150">
                                ${buttonText}
                            </button>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        function updateHistoryLog(history) {
            historyLogContainer.innerHTML = history.map(entry => {
                const messageClass = `log-entry ${entry.type}`;
                const blockTag = (entry.type === 'blocked' || entry.type === 'heuristic' || entry.type === 'client_denied') 
                    ? `<span class="text-xs font-mono px-1 py-0.5 rounded ml-2 ${entry.type === 'heuristic' ? 'bg-purple-200 text-purple-800' : (entry.type === 'client_denied' ? 'bg-red-300 text-red-900' : 'bg-red-200 text-red-800')}">${entry.type.toUpperCase()}</span>` 
                    : '';
                
                return `
                    <div class="${messageClass} flex items-center justify-between border-b border-gray-100 py-2">
                        <span class="text-gray-400 text-xs mr-4">${entry.timestamp}</span>
                        <span class="flex-grow flex items-center">${entry.message}${blockTag}</span>
                    </div>
                `;
            }).join('');
            if (history.length === 0) {
                 historyLogContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No recent activity logged.</p>';
            }
        }
        
        async function fetchBlocklistDetails() {
             const response = await fetch(`${API_BASE}/blocklist`);
             const data = await response.json();
             
             if (data.blocklist && data.blocklist.length > 0) {
                 currentBlocklist.innerHTML = data.blocklist.sort().map(domain => 
                     `<li class="truncate hover:underline cursor-pointer" onclick="document.getElementById('domain-input').value='${domain}'">${domain}</li>`
                 ).join('');
             } else {
                 currentBlocklist.innerHTML = '<li>Blocklist is currently empty.</li>';
             }
        }
        
        function displayClientMessage(message, color) {
            clientMessage.textContent = message;
            clientMessage.className = `mt-3 text-sm text-center font-medium ${color}`;
            setTimeout(() => {
                clientMessage.textContent = '';
                clientMessage.className = 'mt-3 text-sm text-center font-medium';
            }, 5000);
        }

        // --- Other Management Functions (omitted for brevity) ---
        async function toggleService() { /* ... */ }
        async function updateBlocklist(domain, action) { /* ... */ }
        async function loadExternalBlocklist() { /* ... */ }
        function displayLoadUrlMessage(message, color) { /* ... */ }
        function displayManagementMessage(message, color) { /* ... */ }
        function handleServerDown() { /* ... */ }
        


        // --- Event Listeners and Initialization ---

        window.onload = () => {
            // Start the polling interval
            setInterval(fetchStatus, 2000); 
            fetchStatus(); // Initial fetch
            
            // Button handlers
            toggleBtn.addEventListener('click', () => controlClient(null, 'toggle')); 
            addBtn.addEventListener('click', () => updateBlocklist(domainInput.value, 'add'));
            removeBtn.addEventListener('click', () => updateBlocklist(domainInput.value, 'remove'));
            loadUrlBtn.addEventListener('click', loadExternalBlocklist);
            
            // NEW Client Control Handlers
            blockAllBtn.addEventListener('click', () => controlClient(null, 'block_all'));
            unblockAllBtn.addEventListener('click', () => controlClient(null, 'unblock_all'));
            
            // Fix for toggle: Since we use the same control API, we need a generic toggle event
            toggleBtn.addEventListener('click', () => {
                const action = toggleBtn.dataset.status === 'active' ? 'stop' : 'start';
                fetch(`${API_BASE}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
            });
        };
    </script>
</body>
</html>

